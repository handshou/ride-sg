# Convex Timeout Fix

## Problem

Save operations were timing out with error:
```
Save location action failed: TypeError: fetch failed
[cause]: [AggregateError: ] { code: 'ETIMEDOUT' }
```

## Root Cause

The `.env.local` file was manually set to **production** Convex deployment:
```bash
CONVEX_DEPLOYMENT=prod:handsome-seahorse-589
NEXT_PUBLIC_CONVEX_URL=https://handsome-seahorse-589.convex.cloud
```

But the developer was running `npx convex dev` which creates a **local development** deployment.

This mismatch caused:
- ‚ùå Next.js connects to production Convex
- ‚ùå Production has rate limits or network latency
- ‚ùå Operations timeout after 10 seconds
- ‚úÖ Local dev server is running but not being used

## The Fix

### 1. Clean `.env.local`

Remove production Convex URLs from `.env.local`:

```bash
# ‚ùå REMOVE THESE LINES:
# CONVEX_DEPLOYMENT=prod:handsome-seahorse-589
# NEXT_PUBLIC_CONVEX_URL=https://handsome-seahorse-589.convex.cloud

# ‚úÖ ADD THIS COMMENT INSTEAD:
# Convex will be auto-configured by 'npx convex dev'
# DO NOT manually set CONVEX_DEPLOYMENT or NEXT_PUBLIC_CONVEX_URL in development
```

### 2. Run Convex Dev Server

```bash
# Terminal 1: Start Convex dev server
npx convex dev
```

This will:
- ‚úÖ Create a local development deployment
- ‚úÖ Automatically write `NEXT_PUBLIC_CONVEX_URL` to `.env.local`
- ‚úÖ Watch for schema changes

### 3. Restart Next.js Dev Server

```bash
# Terminal 2: Restart Next.js to pick up new env vars
# Press Ctrl+C to stop, then:
pnpm run dev
```

### 4. Verify Setup

After restarting, check `.env.local` should now have:
```bash
# Auto-generated by Convex dev server:
NEXT_PUBLIC_CONVEX_URL=https://your-dev-deployment.convex.cloud
```

## Improved Error Handling

Added better error messages and timeouts:

```typescript
// ‚úÖ Now includes 10-second timeout for all Convex operations
const withTimeout = <T>(promise: Promise<T>, timeoutMs = 10000): Promise<T> => {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) =>
      setTimeout(() => reject(new Error(`Operation timed out after ${timeoutMs}ms`)), timeoutMs)
    ),
  ]);
};

// ‚úÖ Better error messages
if (error.message.includes("timed out")) {
  return {
    error: "Connection timed out. Is 'npx convex dev' running?"
  };
}
```

## Development vs Production

### Development Mode
```bash
# Terminal 1
npx convex dev

# Terminal 2
pnpm run dev

# Result: Uses local dev deployment (fast, no limits)
```

### Production Mode
```bash
# Build and deploy
npx convex deploy && pnpm run build

# Result: Uses production deployment (managed, rate limited)
```

## Quick Reference

| Environment | Convex URL | Command |
|-------------|-----------|---------|
| **Development** | Auto-configured by `convex dev` | `npx convex dev` |
| **Production** | Set in Vercel env vars | `npx convex deploy` |

## Verification

After fixing, successful saves will show:
```
üîó Connecting to Convex: https://your-dev.convex.cloud
üîç Searching for existing results: "Marina Bay Sands"
üíæ Saving new result: "Marina Bay Sands"
‚úÖ Successfully saved to Convex: Marina Bay Sands
```

## Related Files
- `src/lib/actions/save-location-action.ts` - Added timeout handling
- `src/lib/actions/delete-location-action.ts` - Should also add timeout handling
- `src/lib/actions/refresh-location-action.ts` - Should also add timeout handling
- `.env.local` - Clean of production URLs
- `DEV_VS_PROD.md` - Original documentation on dev vs prod setup

