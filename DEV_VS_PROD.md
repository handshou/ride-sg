# Development vs Production: Convex Setup

## 🚨 The Problem

Your `.env.local` was pointing to **PRODUCTION** Convex:
```bash
# ❌ WRONG - This writes to production database!
CONVEX_DEPLOYMENT=prod:handsome-seahorse-589
NEXT_PUBLIC_CONVEX_URL=https://handsome-seahorse-589.convex.cloud
```

**This means every search in development was saving data to production!** 🔥

## ✅ The Solution

Convex has **two separate deployments**:
1. **Development** - Local testing, auto-syncs with code changes
2. **Production** - Live users, stable environment

## How to Run Development Correctly

### Option 1: Use Convex Dev Server (Recommended)

```bash
# Terminal 1: Start Convex dev server
npx convex dev

# Terminal 2: Start Next.js dev server
pnpm run dev
```

Or use the combined script:
```bash
pnpm run dev:all  # Runs both concurrently
```

**What `npx convex dev` does:**
- ✅ Creates a **separate dev deployment** (not production!)
- ✅ Auto-generates `.env.local` with `NEXT_PUBLIC_CONVEX_URL`
- ✅ Watches for schema changes and auto-deploys
- ✅ Provides a dev dashboard at http://localhost:3000/_convex

### Option 2: Manual Dev Deployment

If you prefer manual control:

1. Create a dev deployment:
   ```bash
   npx convex deploy --cmd-url-env-var-name NEXT_PUBLIC_CONVEX_URL_DEV
   ```

2. Update `.env.local`:
   ```bash
   CONVEX_DEPLOYMENT=dev:your-dev-deployment-name
   NEXT_PUBLIC_CONVEX_URL=https://your-dev-deployment.convex.cloud
   ```

## Current Setup (Fixed)

Your `.env.local` now:
```bash
# Mapbox Configuration
MAPBOX_ACCESS_TOKEN=pk.eyJ1...
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=pk.eyJ1...

# Exa API Configuration (server-side only)
EXA_API_KEY=4eacba4c-c298-4883-9d85-9ed7d54fec64

# Convex will be auto-configured by 'npx convex dev'
# DO NOT manually set these in development
```

## Environment Variable Strategy

### Development (`.env.local`)
```bash
# ✅ Let Convex dev server manage these
# NEXT_PUBLIC_CONVEX_URL - Auto-generated by npx convex dev

# ✅ Your API keys
EXA_API_KEY=your_dev_key
MAPBOX_ACCESS_TOKEN=your_token
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your_token
```

### Production (Vercel Environment Variables)
```bash
# ✅ Set these in Vercel Dashboard
CONVEX_DEPLOYMENT=prod:handsome-seahorse-589
CONVEX_DEPLOY_KEY=prod:abc123...  # From Convex dashboard
NEXT_PUBLIC_CONVEX_URL=https://handsome-seahorse-589.convex.cloud

# ✅ Production API keys (mark as "Secret" in Vercel)
EXA_API_KEY=your_prod_key
MAPBOX_ACCESS_TOKEN=your_prod_token
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your_prod_token
```

## How Convex Deployments Work

```
┌─────────────────────────────────────────────────────────┐
│                 Your Convex Project                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  🟦 Dev Deployment                                       │
│  ├─ URL: dev:name-animal-123.convex.cloud              │
│  ├─ Data: Separate dev database                        │
│  ├─ Schema: Auto-syncs with local code                 │
│  └─ Used by: npx convex dev                            │
│                                                          │
│  🟩 Production Deployment                               │
│  ├─ URL: prod:handsome-seahorse-589.convex.cloud       │
│  ├─ Data: Production database (real users!)           │
│  ├─ Schema: Manually deployed                          │
│  └─ Used by: Vercel production                         │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## Quick Start

1. **Stop any running dev servers**
2. **Run Convex dev server:**
   ```bash
   npx convex dev
   ```
   
3. **In another terminal, run Next.js:**
   ```bash
   pnpm run dev
   ```

4. **Verify you're using dev:**
   - Check the Convex dev dashboard
   - Look for "dev:" in the deployment URL
   - Data should NOT appear in production Convex dashboard

## Checking Which Deployment You're Using

### In Terminal
```bash
# Check .env.local
cat .env.local | grep CONVEX

# Check Convex CLI
npx convex info
```

### In Browser Console
```javascript
// Check deployment URL
console.log(process.env.NEXT_PUBLIC_CONVEX_URL);
// Should be: dev:... (NOT prod:...)
```

### In Convex Dashboard
- Go to https://dashboard.convex.dev/
- Check which deployment is receiving writes
- Dev writes should go to dev deployment only

## Best Practices

### ✅ DO:
- Use `npx convex dev` for local development
- Keep production credentials OUT of `.env.local`
- Test dangerous operations in dev first
- Use separate API keys for dev/prod if possible

### ❌ DON'T:
- Manually set `CONVEX_DEPLOYMENT=prod:...` in `.env.local`
- Point local dev to production database
- Commit `.env.local` to git
- Use production API keys in development

## If You Accidentally Wrote to Production

Don't panic! You can:

1. **Check production data:**
   ```bash
   npx convex data --prod
   ```

2. **Remove test data:**
   - Go to Convex dashboard → Data
   - Select test records
   - Delete manually

3. **Export production backup:**
   ```bash
   npx convex export --prod
   ```

## Troubleshooting

### "Convex URL not found"
```bash
# Start Convex dev server first
npx convex dev

# Then in another terminal
pnpm run dev
```

### "Schema mismatch"
```bash
# Convex dev server auto-syncs schemas
# Just save your schema.ts file and it will update
```

### "Wrong deployment"
```bash
# Check which deployment you're using
cat .env.local | grep CONVEX
npx convex info

# Should see dev:..., not prod:...
```

## Summary

- **Development**: `npx convex dev` → **dev:** deployment → Safe testing
- **Production**: Vercel env vars → **prod:** deployment → Real users

**Never mix them!** Keep production safe! 🔒

