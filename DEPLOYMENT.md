# Deployment Guide

This guide explains how to deploy the Ride-SG application to Vercel with Convex backend.

## Prerequisites

1. **Convex Account**: Sign up at [convex.dev](https://convex.dev)
2. **Vercel Account**: Sign up at [vercel.com](https://vercel.com)
3. **Convex Project**: Set up your Convex project locally first

## Local Development Setup

1. **Install Dependencies**
   ```bash
   pnpm install
   ```

2. **Set Up Convex**
   ```bash
   npx convex dev
   ```
   This will:
   - Generate the `convex/_generated` files
   - Start the Convex development server
   - Create `.env.local` with your development Convex URL

3. **Run Development Server**
   ```bash
   pnpm run dev
   ```

## Vercel Deployment Setup

### Step 1: Generate Convex Production Deploy Key

1. Go to your [Convex Dashboard](https://dashboard.convex.dev)
2. Navigate to your project's **Settings** page
3. Click **"Generate Production Deploy Key"**
4. Copy the deploy key (you'll need this in the next step)

### Step 2: Configure Vercel Project

1. **Import Your Repository** to Vercel

2. **Set Build Command** in Vercel project settings:
   - Navigate to: **Settings → Build & Development Settings**
   - Set **Build Command** to:
     ```bash
     npx convex deploy && pnpm run build
     ```
   
   **Why this works:**
   - `npx convex deploy` runs first and generates the `convex/_generated` files
   - `&&` ensures the Next.js build only starts after Convex deployment succeeds
   - `pnpm run build` runs the Next.js build with all required files present

3. **Configure Environment Variables**:
   - Navigate to: **Settings → Environment Variables**
   - Add the following variables for **Production**, **Preview**, and **Development**:
   
   | Variable Name | Value | Description |
   |---------------|-------|-------------|
   | `CONVEX_DEPLOY_KEY` | (your deploy key from Step 1) | Required for `npx convex deploy` |
   | `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN` | (your Mapbox token) | Required for Mapbox functionality |
   | `MAPBOX_ACCESS_TOKEN` | (your Mapbox token) | Server-side Mapbox operations |

4. **Set Install Command** (if needed):
   - If Vercel doesn't auto-detect pnpm, set **Install Command** to:
     ```bash
     pnpm install
     ```

### Step 3: Deploy

1. **Push to GitHub** (or your Git provider)
   ```bash
   git push origin main
   ```

2. **Vercel Auto-Deploy**
   - Vercel will automatically detect the push
   - It will run: `npx convex deploy && pnpm run build`
   - The Convex deployment will:
     - Generate `convex/_generated/server.ts`
     - Generate `convex/_generated/api.ts`
     - Generate `convex/_generated/dataModel.d.ts`
     - Set the `NEXT_PUBLIC_CONVEX_URL` environment variable automatically
   - Then Next.js build will proceed with all required files

## Understanding the Build Process

### The Problem (Before)
```bash
# Old build:vercel script
npx convex deploy --cmd 'pnpm run build' --cmd-url-env-var-name NEXT_PUBLIC_CONVEX_URL
```
- This runs both commands **concurrently** using `--cmd`
- Next.js build starts before `_generated` files are ready
- Results in: `Cannot find module './_generated/server'` error

### The Solution (Current)
```bash
# New approach
npx convex deploy && pnpm run build
```
- Commands run **sequentially** using `&&`
- Convex deploy completes first and generates all files
- Next.js build has all required files available
- Build succeeds ✅

## Convex Generated Files

The following files are generated by `npx convex deploy` and should NOT be committed:

```
convex/_generated/
├── api.d.ts          # Type definitions for Convex API
├── api.js            # JavaScript API exports
├── dataModel.d.ts    # Type definitions for database schema
├── server.d.ts       # Type definitions for server functions
└── server.js         # Server function implementations
```

These files are automatically generated during:
- Local development: `npx convex dev`
- Production deployment: `npx convex deploy`

## Environment Variables Reference

### Convex Variables
- `CONVEX_DEPLOY_KEY`: Production deploy key from Convex Dashboard
- `NEXT_PUBLIC_CONVEX_URL`: Automatically set by Convex deployment

### Mapbox Variables
- `MAPBOX_ACCESS_TOKEN`: Server-side Mapbox operations
- `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN`: Client-side Mapbox operations

Get your Mapbox token from: https://account.mapbox.com/access-tokens/

## Troubleshooting

### Error: Cannot find module './_generated/server'

**Cause**: The Convex generated files are missing during build.

**Solution**: Ensure your Vercel build command is:
```bash
npx convex deploy && pnpm run build
```

### Error: Missing CONVEX_DEPLOY_KEY

**Cause**: The `CONVEX_DEPLOY_KEY` environment variable is not set in Vercel.

**Solution**: 
1. Generate a production deploy key in Convex Dashboard
2. Add it to Vercel environment variables
3. Redeploy

### Build Fails After Convex Deploy

**Cause**: Your Convex functions or schema have errors.

**Solution**:
1. Test locally with `npx convex dev`
2. Check Convex dashboard for errors
3. Fix schema/function issues
4. Redeploy

## Preview Deployments

For preview deployments (PRs), Vercel will:
1. Run `npx convex deploy` which creates a preview Convex deployment
2. Set `NEXT_PUBLIC_CONVEX_URL` to the preview URL
3. Build and deploy your Next.js app
4. Each PR gets its own isolated Convex deployment

## Production vs Preview Environments

- **Production**: Uses production Convex deployment
- **Preview**: Uses temporary preview Convex deployment
- Each environment has isolated data
- Preview deployments are automatically cleaned up

## Additional Resources

- [Convex Documentation](https://docs.convex.dev)
- [Convex + Vercel Guide](https://docs.convex.dev/production/hosting/vercel)
- [Vercel Build Configuration](https://vercel.com/docs/build-step)
- [Effect-TS Documentation](https://effect.website/)

## Scripts Reference

```bash
# Local Development
pnpm run dev              # Start Next.js dev server
npx convex dev           # Start Convex dev server (run in separate terminal)

# Building
pnpm run build           # Build Next.js app (requires Convex generated files)
pnpm run type-check      # Type check without building
pnpm run lint            # Lint codebase

# Testing
pnpm run test            # Run unit tests
pnpm run test:watch      # Run unit tests in watch mode
pnpm run test:e2e        # Run end-to-end tests
pnpm run check-all       # Run full test suite (lint + type-check + test + build)

# Convex Operations
npx convex dev           # Generate files and start dev server
npx convex deploy        # Deploy to production (requires CONVEX_DEPLOY_KEY)
npx convex dashboard     # Open Convex dashboard
```

## Support

For issues specific to:
- **Convex**: [Convex Discord](https://convex.dev/community)
- **Vercel**: [Vercel Support](https://vercel.com/support)
- **This Project**: Open an issue in the GitHub repository

